---
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import MediaCard from "@components/MediaCard.astro";
import { SITE, MEDIA } from "@consts";
import { existsSync } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

import movieData from "../../data/douban/movie.json";
import bookData from "../../data/douban/book.json";

type DoubanRating = {
  max?: number;
  value?: number;
  star_count?: number;
  count?: number;
};

type DoubanSubject = {
  title?: string;
  url?: string;
  sharing_url?: string;
  pic?: {
    normal?: string;
    large?: string;
  };
  cover_url?: string;
  card_subtitle?: string;
  rating?: DoubanRating;
  type?: string;
  subtype?: string;
  genres?: string[];
};

type DoubanItem = {
  comment?: string;
  rating?: DoubanRating;
  create_time?: string;
  status?: string;
  is_private?: boolean;
  sharing_url?: string;
  subject?: DoubanSubject;
};

type NormalizedItem = {
  title: string;
  url?: string;
  cover?: string;
  subtitle?: string;
  comment?: string;
  createdAt?: Date;
  myRating?: number;
  subjectType?: string;
  genres?: string[];
};

const publicDir = fileURLToPath(new URL("../../public", import.meta.url));
const movieEntries = normalizeItems(movieData as DoubanItem[], 5, "movie");
const books = normalizeItems(bookData as DoubanItem[], 5, "book");

const isAnimation = (item: NormalizedItem) => item.genres?.includes("动画") ?? false;
const movieItems = movieEntries.filter((item) => !isAnimation(item) && item.subjectType !== "tv");
const seriesItems = movieEntries.filter((item) => !isAnimation(item) && item.subjectType === "tv");
const animeItems = movieEntries.filter((item) => isAnimation(item));

function parseDate(value?: string): Date | undefined {
  if (!value) return;
  const normalized = value.replace(" ", "T");
  const parsed = new Date(normalized);
  if (Number.isNaN(parsed.valueOf())) return;
  return parsed;
}

function formatRating(rating?: DoubanRating, fallbackMax = 5): number | undefined {
  if (!rating || typeof rating.value !== "number") return;
  const max = typeof rating.max === "number" ? rating.max : fallbackMax;
  if (max <= 0) return;
  const value = Math.max(0, Math.min(rating.value, max));
  return value;
}

function normalizeItems(items: DoubanItem[], fallbackMax: number, kind: "movie" | "book"): NormalizedItem[] {
  return items
    .filter(item => item.status === "done" && !item.is_private)
    .sort((a, b) => {
      const aTime = parseDate(a.create_time)?.valueOf() ?? 0;
      const bTime = parseDate(b.create_time)?.valueOf() ?? 0;
      return bTime - aTime;
    })
    .map((item) => {
      const subject = item.subject ?? {};
      const title = subject.title ?? "Untitled";
      const url = subject.url ?? subject.sharing_url ?? item.sharing_url;
      const subjectId = getSubjectId(subject.url ?? subject.sharing_url ?? item.sharing_url);
      const remoteCover = subject.pic?.normal ?? subject.cover_url;
      const cover = resolveLocalCover(kind, subjectId, remoteCover);
      const subtitle = subject.card_subtitle;
      const comment = item.comment?.trim() || undefined;
      const createdAt = parseDate(item.create_time);
      const myRating = formatRating(item.rating, fallbackMax);
      const subjectType = subject.subtype ?? subject.type;
      const genres = subject.genres ?? [];

      return {
        title,
        url,
        cover,
        subtitle,
        comment,
        createdAt,
        myRating,
        subjectType,
        genres,
      };
    });
}

function getSubjectId(value?: string): string | undefined {
  if (!value) return;
  const match = value.match(/subject\/(\d+)/);
  return match?.[1];
}

function getImageExtension(url?: string): string {
  if (!url) return ".jpg";
  try {
    const pathname = new URL(url).pathname;
    const ext = path.extname(pathname);
    return ext || ".jpg";
  } catch {
    return ".jpg";
  }
}

function resolveLocalCover(kind: "movie" | "book", subjectId?: string, imageUrl?: string): string | undefined {
  if (!subjectId) return;
  const ext = getImageExtension(imageUrl);
  const relativePath = `/douban/${kind}/${subjectId}${ext}`;
  const fullPath = path.join(publicDir, "douban", kind, `${subjectId}${ext}`);
  return existsSync(fullPath) ? relativePath : undefined;
}
---

<PageLayout title={`${MEDIA.TITLE} | ${SITE.NAME}`} description={MEDIA.DESCRIPTION}>
  <Container>
    <div class="space-y-10">
      <div class="animate space-y-3">
        <nav id="media-tabs" class="flex flex-wrap gap-5 text-sm justify-start" role="tablist" aria-label="Media categories">
          <button
            type="button"
            id="media-tab-movies"
            role="tab"
            aria-controls="movies"
            aria-selected="true"
            data-tab="movies"
            data-active="true"
            class="group px-0 py-1 text-base text-stone-600 dark:text-stone-300 hover:text-black dark:hover:text-white transition-colors border-b border-transparent data-[active=true]:border-black/60 data-[active=true]:text-black data-[active=true]:dark:border-white/60 data-[active=true]:dark:text-white"
          >
            Movies
          </button>
          <button
            type="button"
            id="media-tab-series"
            role="tab"
            aria-controls="series"
            aria-selected="false"
            data-tab="series"
            data-active="false"
            class="group px-0 py-1 text-base text-stone-600 dark:text-stone-300 hover:text-black dark:hover:text-white transition-colors border-b border-transparent data-[active=true]:border-black/60 data-[active=true]:text-black data-[active=true]:dark:border-white/60 data-[active=true]:dark:text-white"
          >
            Series
          </button>
          <button
            type="button"
            id="media-tab-anime"
            role="tab"
            aria-controls="anime"
            aria-selected="false"
            data-tab="anime"
            data-active="false"
            class="group px-0 py-1 text-base text-stone-600 dark:text-stone-300 hover:text-black dark:hover:text-white transition-colors border-b border-transparent data-[active=true]:border-black/60 data-[active=true]:text-black data-[active=true]:dark:border-white/60 data-[active=true]:dark:text-white"
          >
            Anime
          </button>
          <button
            type="button"
            id="media-tab-books"
            role="tab"
            aria-controls="books"
            aria-selected="false"
            data-tab="books"
            data-active="false"
            class="group px-0 py-1 text-base text-stone-600 dark:text-stone-300 hover:text-black dark:hover:text-white transition-colors border-b border-transparent data-[active=true]:border-black/60 data-[active=true]:text-black data-[active=true]:dark:border-white/60 data-[active=true]:dark:text-white"
          >
            Books
          </button>
        </nav>
      </div>

      <section id="movies" data-tab-panel="movies" role="tabpanel" aria-labelledby="media-tab-movies" class="space-y-4 scroll-mt-24">
        <ul class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {movieItems.map((item) => (
            <MediaCard item={item} />
          ))}
        </ul>
      </section>

      <section id="series" data-tab-panel="series" role="tabpanel" aria-labelledby="media-tab-series" class="space-y-4 scroll-mt-24" hidden>
        <ul class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {seriesItems.map((item) => (
            <MediaCard item={item} />
          ))}
        </ul>
      </section>

      <section id="anime" data-tab-panel="anime" role="tabpanel" aria-labelledby="media-tab-anime" class="space-y-4 scroll-mt-24" hidden>
        <ul class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {animeItems.map((item) => (
            <MediaCard item={item} />
          ))}
        </ul>
      </section>

      <section id="books" data-tab-panel="books" role="tabpanel" aria-labelledby="media-tab-books" class="space-y-4 scroll-mt-24" hidden>
        <ul class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {books.map((item) => (
            <MediaCard item={item} />
          ))}
        </ul>
      </section>
    </div>
  </Container>

  <script is:inline>
    const initMediaTabs = () => {
      const tablist = document.getElementById("media-tabs");
      if (!tablist) return;
      if (tablist.dataset.bound === "true") return;
      tablist.dataset.bound = "true";

      const tabs = Array.from(tablist.querySelectorAll("[data-tab]"));
      const panels = Array.from(document.querySelectorAll("[data-tab-panel]"));
      if (!tabs.length || !panels.length) return;
      const tabNames = tabs
        .map((tab) => tab.getAttribute("data-tab"))
        .filter(Boolean);
      const tabSet = new Set(tabNames);

      const activate = (name, options = { updateHash: false }) => {
        tabs.forEach((tab) => {
          const active = tab.getAttribute("data-tab") === name;
          tab.setAttribute("aria-selected", active ? "true" : "false");
          tab.setAttribute("data-active", active ? "true" : "false");
        });

        panels.forEach((panel) => {
          const active = panel.getAttribute("data-tab-panel") === name;
          panel.toggleAttribute("hidden", !active);
        });

        if (options.updateHash) {
          const nextHash = `#${name}`;
          if (window.location.hash !== nextHash) {
            history.replaceState(null, "", nextHash);
          }
        }
      };

      tabs.forEach((tab) => {
        tab.addEventListener("click", (event) => {
          event.preventDefault();
          const name = tab.getAttribute("data-tab");
          if (name) activate(name, { updateHash: true });
        });
      });

      const hashName = window.location.hash.replace("#", "");
      const initial = tabSet.has(hashName) ? hashName : "movies";
      activate(initial, { updateHash: false });
    };

    document.addEventListener("DOMContentLoaded", initMediaTabs);
    document.addEventListener("astro:page-load", initMediaTabs);
  </script>
</PageLayout>
